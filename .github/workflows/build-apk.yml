name: Build APK with EAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-apk
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          npm install -g eas-cli
          pnpm install

      - name: Build APK with EAS
        id: eas_build
        run: |
          eas build --platform android --profile preview --non-interactive --json > build-output.json
          cat build-output.json
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Extract build URL and download APK
        run: |
          # Note: jq is pre-installed on ubuntu-latest runners
          BUILD_URL=$(jq -r '.[0].artifacts.buildUrl // .artifacts.buildUrl // empty' build-output.json)
          if [ -z "$BUILD_URL" ]; then
            echo "Build URL not found in output"
            cat build-output.json
            exit 1
          fi
          echo "Downloading APK from: $BUILD_URL"
          curl -L -f --retry 3 -o milkdrop3.apk "$BUILD_URL"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: milkdrop3-apk
          path: 'milkdrop3.apk'
          retention-days: 30

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: MilkDrop 3 Mobile Build ${{ github.run_number }}
          body: |
            ## MilkDrop 3 Mobile APK Build

            **Build Number:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}

            Download the APK from the assets section below.

            ### Installation Instructions
            1. Download the APK file
            2. Transfer to your Android device
            3. Enable "Install from Unknown Sources" in Settings
            4. Tap the APK to install
            5. Launch MilkDrop 3!

            ### Features
            - WebGL visualization engine
            - 319 curated presets
            - Touch gesture controls
            - 70+ customization settings
            - Preset save/share functionality

            **Requires:** Android 7.0+ (API 24)
          files: milkdrop3.apk
          draft: false
          prerelease: false

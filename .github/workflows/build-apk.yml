name: Build APK with EAS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install EAS CLI
        run: npm install -g eas-cli
        
      - name: Install project dependencies
        run: pnpm install

      - name: Build APK with EAS
        id: eas-build
        run: |
          echo "Starting EAS build..."
          eas build --platform android --profile preview --non-interactive --no-wait > build-output.txt
          cat build-output.txt
          
          # Extract build URL from output
          BUILD_URL=$(grep -oP 'https://expo\.dev/accounts/[^/]+/projects/[^/]+/builds/[a-zA-Z0-9-]+' build-output.txt | head -1)
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          
          if [ -z "$BUILD_URL" ]; then
            echo "Error: Could not extract build URL from EAS output"
            exit 1
          fi
          
          echo "Build started at: $BUILD_URL"
          echo "Note: Build will continue in the cloud. Check EAS dashboard for progress."
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Build Info
        continue-on-error: true
        run: |
          echo "## EAS Build Started" >> $GITHUB_STEP_SUMMARY
          echo "Build URL: ${{ steps.eas-build.outputs.build_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The APK is being built in the cloud by EAS." >> $GITHUB_STEP_SUMMARY
          echo "Download the APK from the EAS dashboard once the build completes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Instructions" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for the EAS build to complete (check the URL above)" >> $GITHUB_STEP_SUMMARY
          echo "2. Download the APK from EAS" >> $GITHUB_STEP_SUMMARY
          echo "3. Transfer to your Android device" >> $GITHUB_STEP_SUMMARY
          echo "4. Enable 'Install from Unknown Sources' in Settings" >> $GITHUB_STEP_SUMMARY
          echo "5. Tap the APK to install" >> $GITHUB_STEP_SUMMARY
          echo "6. Launch MilkDrop 3!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Requires:** Android 7.0+ (API Level 24+)" >> $GITHUB_STEP_SUMMARY

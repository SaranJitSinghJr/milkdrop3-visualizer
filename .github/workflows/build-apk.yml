name: Build APK with EAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract project source
        run: |
          tar -xzf milkdrop3-mobile-source.tar.gz
          cd milkdrop3-mobile
          ls -la

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install project dependencies
        working-directory: milkdrop3-mobile
        run: pnpm install

      - name: Build APK with EAS
        working-directory: milkdrop3-mobile
        run: eas build --platform android --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: MilkDrop 3 Mobile Build ${{ github.run_number }}
          body: |
            ## MilkDrop 3 Mobile APK Build
            
            **Build Number:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            Download the APK from the EAS build dashboard at [expo.dev](https://expo.dev).
            
            ### Installation Instructions
            1. Download the APK file from the EAS build link
            2. Transfer to your Android device
            3. Enable "Install from Unknown Sources" in Settings
            4. Tap the APK to install
            5. Launch MilkDrop 3!
            
            ### Features
            - WebGL visualization engine
            - 319 curated presets
            - Touch gesture controls
            - 70+ customization settings
            - Preset save/share functionality
            
            **Requires:** Android OS 16+ (API Level 35+)
          draft: false
          prerelease: false

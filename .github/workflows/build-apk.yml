name: Build APK with EAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install EAS CLI
        run: npm install -g eas-cli
        
      - name: Install project dependencies
        run: pnpm install

      - name: Build APK with EAS
        id: eas_build
        run: |
          eas build --platform android --profile preview --non-interactive --json | tee build_output.json
          
          # Extract the artifact URL using jq if available
          if command -v jq &> /dev/null; then
            ARTIFACT_URL=$(jq -r '.[0].artifacts.buildUrl // empty' build_output.json 2>/dev/null || true)
          fi
          
          if [ -n "$ARTIFACT_URL" ]; then
            echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
            echo "APK available at: $ARTIFACT_URL"
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: MilkDrop 3 Mobile Build ${{ github.run_number }}
          body: |
            ## MilkDrop 3 Mobile APK Build
            
            **Build Number:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            ### Download APK
            ${{ steps.eas_build.outputs.artifact_url != '' && format('Download the APK from: {0}', steps.eas_build.outputs.artifact_url) || 'Check the EAS build dashboard at https://expo.dev for the APK download link.' }}
            
            ### Installation Instructions
            1. Download the APK file from the link above
            2. Transfer to your Android device
            3. Enable "Install from Unknown Sources" in Settings
            4. Tap the APK to install
            5. Launch MilkDrop 3!
            
            ### Features
            - WebGL visualization engine
            - 319 curated presets
            - Touch gesture controls
            - 70+ customization settings
            - Preset save/share functionality
            
            **Requires:** Android 7.0+ (API Level 24+)
          draft: false
          prerelease: false

name: Build APK with EAS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      APK_FILENAME: milkdrop3.apk
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install EAS CLI
        run: npm install -g eas-cli
        
      - name: Install project dependencies
        run: pnpm install

      - name: Build APK with EAS
        id: eas-build
        run: |
          echo "Starting EAS build..."
          if ! eas build --platform android --profile preview --non-interactive --json > build-output.json; then
            echo "Error: EAS build command failed"
            cat build-output.json 2>/dev/null || echo "No output file generated"
            exit 1
          fi
          cat build-output.json
          
          # Validate JSON structure
          if ! jq -e '.[0]' build-output.json > /dev/null 2>&1; then
            echo "Error: Unexpected JSON structure from EAS output"
            cat build-output.json
            exit 1
          fi
          
          # Extract build URL and artifact URL from output
          BUILD_URL=$(jq -r '.[0].logsUrl // empty' build-output.json)
          ARTIFACT_URL=$(jq -r '.[0].artifacts.buildUrl // empty' build-output.json)
          
          # Validate ARTIFACT_URL (critical)
          if [ -z "$ARTIFACT_URL" ] || [ "$ARTIFACT_URL" = "null" ]; then
            echo "Error: Could not extract artifact URL from EAS output"
            cat build-output.json
            exit 1
          fi
          
          # Validate BUILD_URL (non-critical, set to N/A if missing)
          if [ -z "$BUILD_URL" ] || [ "$BUILD_URL" = "null" ]; then
            echo "Warning: Could not extract build logs URL"
            BUILD_URL="N/A"
          fi
          
          # Output values for subsequent steps
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          
          echo "Build completed successfully!"
          echo "Build logs: $BUILD_URL"
          echo "APK URL: $ARTIFACT_URL"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download APK from EAS
        run: |
          APK_URL="${{ steps.eas-build.outputs.artifact_url }}"
          
          # Validate URL before downloading
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "Error: APK URL is empty or invalid"
            exit 1
          fi
          
          echo "Downloading APK from: $APK_URL"
          curl -L --fail --max-time 600 --connect-timeout 60 -o "$APK_FILENAME" "$APK_URL"
          
          if [ ! -f "$APK_FILENAME" ] || [ ! -s "$APK_FILENAME" ]; then
            echo "Error: APK download failed or file is empty"
            exit 1
          fi
          
          echo "APK downloaded successfully"
          ls -lh "$APK_FILENAME"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: milkdrop3-apk
          path: ${{ env.APK_FILENAME }}
          retention-days: 30

      - name: Build Info
        continue-on-error: true
        run: |
          echo "## EAS Build Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "Build URL: ${{ steps.eas-build.outputs.build_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download APK" >> $GITHUB_STEP_SUMMARY
          echo "The APK has been built and is available as a GitHub Actions artifact." >> $GITHUB_STEP_SUMMARY
          echo "Download it from the 'Artifacts' section at the top of this workflow run page." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Instructions" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the 'milkdrop3-apk' artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the ZIP file to get 'milkdrop3.apk'" >> $GITHUB_STEP_SUMMARY
          echo "3. Transfer to your Android device" >> $GITHUB_STEP_SUMMARY
          echo "4. Enable 'Install from Unknown Sources' in Settings" >> $GITHUB_STEP_SUMMARY
          echo "5. Tap the APK to install" >> $GITHUB_STEP_SUMMARY
          echo "6. Launch MilkDrop 3!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Requires:** Android 7.0+ (API Level 24+)" >> $GITHUB_STEP_SUMMARY

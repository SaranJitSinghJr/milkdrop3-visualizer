name: Build APK with EAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install -g eas-cli pnpm
        
      - name: Install project dependencies
        run: pnpm install

      - name: Build APK with EAS
        run: eas build --platform android --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: milkdrop3-apk
          path: '*.apk'
          retention-days: 30

      - name: Create Release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ github.run_number }}
          release_name: MilkDrop 3 Mobile Build ${{ github.run_number }}
          body: |
            ## MilkDrop 3 Mobile APK Build
            
            **Build Number:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            Download the APK from the artifacts section below.
            
            ### Installation Instructions
            1. Download the APK file
            2. Transfer to your Android device
            3. Enable "Install from Unknown Sources" in Settings
            4. Tap the APK to install
            5. Launch MilkDrop 3!
            
            ### Features
            - WebGL visualization engine
            - 319 curated presets
            - Touch gesture controls
            - 70+ customization settings
            - Preset save/share functionality
            
            **Requires:** Android OS 7.0+ (API Level 24+)
          draft: false
          prerelease: false
